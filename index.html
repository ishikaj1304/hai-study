<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // ====== CONFIG ======
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby9Qr9HKXruTlhsJ4c8J3yCvSJXE5WB-ysAUoFUEzaTJvgykVImStUXLnWOjOashncI_g/exec';
  const CSV_URL = 'data/stimuli.csv'; // fixed path
  // ====================

  const $ = sel => document.querySelector(sel);
  const $all = sel => Array.from(document.querySelectorAll(sel));
  const params = new URLSearchParams(location.search);
  const uuid = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
  );
  const clamp01 = x => Math.max(0, Math.min(1, x));
  function shuffle(arr, seed=Math.random()){
    function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}}
    const prng = mulberry32(Math.floor(seed*1e9));
    for(let i=arr.length-1;i>0;i--){const j=Math.floor(prng()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}
    return arr;
  }

  // Random participant ID
  function genParticipantID() {
    const letters = "ABCDEFGHJKLMNPQRSTUVWXYZ";
    const nums = Math.floor(1000 + Math.random() * 9000);
    const prefix = letters[Math.floor(Math.random() * letters.length)];
    return `P${prefix}${nums}`;
  }

  const state = {
    pid: genParticipantID(),
    cond: (params.get('cond') || 'solo').toLowerCase(), // solo | ai
    n: Math.max(1, parseInt(params.get('n') || '20', 10)),
    orderSeed: Math.random().toString().slice(2,10),
    sessionId: uuid(),
    trials: [],
    i: 0, tStart: 0, currentRow: null, completionCode: null
  };

  // Prefill from URL (with null-guards)
  $all('input[name="cond"]').forEach(r => r.checked = (r.value === state.cond));
  const nTrialsEl = $('#nTrials'); if (nTrialsEl) nTrialsEl.value = state.n;
  const nTrialsLabelEl = $('#nTrialsLabel'); if (nTrialsLabelEl) nTrialsLabelEl.textContent = state.n;
  const confEl = $('#conf'); if (confEl) confEl.addEventListener('input', e => { const cv = $('#confVal'); if (cv) cv.textContent = e.target.value; });

  const startBtn = $('#startBtn');
  if (startBtn) startBtn.addEventListener('click', async () => {
    const condEl = $all('input[name="cond"]').find(r => r.checked);
    state.cond = condEl ? condEl.value : state.cond;
    state.n = Math.max(1, parseInt((nTrialsEl && nTrialsEl.value) ? nTrialsEl.value : state.n, 10));

    try{
      const rows = await loadCSV(CSV_URL);
      if(!rows.length) throw new Error('Empty CSV');
      shuffle(rows, parseInt(state.orderSeed,10)/1e8);
      state.trials = rows.slice(0, state.n);
      if (nTrialsLabelEl) nTrialsLabelEl.textContent = state.n;

      $('#screen-consent')?.classList.add('hidden');
      $('#screen-trial')?.classList.remove('hidden');
      state.i = 0;
      renderTrial();
    }catch(err){
      alert('Failed to load CSV: ' + err.message);
    }
  });

  async function loadCSV(url){
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    // Schema: image_url, id, ground_truth, model_prob_ai
    const rows = parsed.data.map(r => ({
      id: (r.id||'').trim(),
      image_url: (r.image_url||r.url||'').trim(),
      ground_truth: (r.ground_truth||'').trim().toLowerCase(),
      model_prob_ai: (r.model_prob_ai===''||r.model_prob_ai==null) ? null : Number(r.model_prob_ai)
    })).filter(r => r.image_url && r.id);
    return rows;
  }

  function renderTrial(){
    const t = state.trials[state.i];
    state.currentRow = t;

    const prog = $('#progBar'); if (prog) prog.style.width = `${(state.i/state.trials.length)*100}%`;
    const badge = $('#trialBadge'); if (badge) badge.textContent = `Trial ${state.i+1} of ${state.trials.length}`;

    const img = $('#artImg');
    if (img) {
      img.src = t.image_url;
      img.onerror = () => alert('Image failed to load: ' + t.image_url);
    }

    // HINTS â€” show only when cond=ai
    const hint = $('#aiHint');
    if(hint){
      if(state.cond==='ai' && typeof t.model_prob_ai==='number' && !Number.isNaN(t.model_prob_ai)){
        const pAI = clamp01(t.model_prob_ai);
        const pAIel = $('#pAI'); if (pAIel) pAIel.textContent = pAI.toFixed(2);
        const pH = $('#pHuman'); if (pH) pH.textContent = (1-pAI).toFixed(2);
        hint.classList.remove('hidden');
      }else{
        hint.classList.add('hidden');
      }
    }

    const conf = $('#conf'); if (conf) conf.value = 3;
    const confVal = $('#confVal'); if (confVal) confVal.textContent = '3';
    const nextBtn = $('#nextBtn'); if (nextBtn) nextBtn.disabled = true;
    state.tStart = performance.now();
  }

  $all('.controls .btn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const answer = e.currentTarget.getAttribute('data-answer'); // 'ai' | 'human'
      const rt = Math.round(performance.now() - state.tStart);
      const conf = Number($('#conf')?.value || 3);
      const gt = state.currentRow.ground_truth;
      const correct = gt ? (answer.toLowerCase() === gt) : '';

      const payload = {
        participant_id: state.pid,
        condition: state.cond,
        trial_index: state.i + 1,
        total_trials: state.trials.length,
        stimulus_id: state.currentRow.id,
        image_url: state.currentRow.image_url,
        model_prob_ai: (typeof state.currentRow.model_prob_ai==='number') ? state.currentRow.model_prob_ai : '',
        hint_shown: state.cond === 'ai' && typeof state.currentRow.model_prob_ai==='number',
        response: answer,
        ground_truth: state.currentRow.ground_truth || '',
        correct,
        confidence: conf,
        rt_ms: rt,
        order_seed: state.orderSeed,
        session_id: state.sessionId
      };

      try{
        await postRow(payload);
        const nextBtn = $('#nextBtn'); if (nextBtn) nextBtn.disabled = false;
        e.currentTarget.style.outline='2px solid var(--focus)';
        setTimeout(()=>{e.currentTarget.style.outline='none'}, 200);
      }catch(err){
        alert('Save failed. Please check your connection and try again.\n' + err.message);
      }
    });
  });

  const nextBtn = $('#nextBtn');
  if (nextBtn) nextBtn.addEventListener('click', async ()=>{
    state.i++;
    if(state.i < state.trials.length){
      renderTrial();
    }else{
      state.completionCode = 'C' + Math.random().toString(36).slice(2,8).toUpperCase();
      try{
        await postRow({
          participant_id: state.pid, condition: state.cond,
          trial_index: 'FINAL', total_trials: state.trials.length,
          stimulus_id: '', image_url: '', model_prob_ai: '', hint_shown: '',
          response: 'DONE', ground_truth: '', correct: '', confidence: '',
          rt_ms: '', order_seed: state.orderSeed, session_id: state.sessionId,
          completion_code: state.completionCode
        });
      }catch(e){}
      $('#screen-trial')?.classList.add('hidden');
      $('#screen-done')?.classList.remove('hidden');
      const codeBox = $('#codeBox'); if (codeBox) codeBox.textContent = state.completionCode;
    }
  });

  const copyBtn = $('#copyBtn');
  if (copyBtn) copyBtn.addEventListener('click', ()=> {
    navigator.clipboard.writeText(state.completionCode || '').then(()=>alert('Copied!'));
  });

  async function postRow(row){
    // With wildcard CORS on Apps Script, no need to send origin; harmless if you keep it
    const ua = navigator.userAgent;
    const reqUrl = APPS_SCRIPT_URL + `?ua=${encodeURIComponent(ua)}`;
    const res = await fetch(reqUrl, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(row)
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Unknown backend error');
    return data;
  }
});
</script>
