<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Modernism Origin Judgement Study</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .btn.clicked{ outline: 2px solid var(--focus); }
    :root{--bg:#0f1115;--panel:#181b22;--ink:#e6e8ee;--muted:#a5adbd;--accent:#7aa2f7;--danger:#f7768e;--ok:#9ece6a;--border:#262a33;--focus:#2ac3de;--btn:#1f2330}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:#0f1115}
    .wrap{max-width:920px;margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    header{margin-bottom:16px} h1{font-size:22px;margin:0 0 8px}
    .row{display:grid;gap:12px}.row.cols-2{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted);font-size:14px}
    .imgbox{border-radius:16px;overflow:hidden;background:#0b0d12;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;min-height:420px}
    img.art{max-width:100%;max-height:70vh;display:block}
    .hint{margin-top:10px;padding:10px 12px;border:1px dashed #2b3040;border-radius:12px;background:#141824}
    .hint strong{color:var(--accent)}
    .controls{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr));margin-top:16px}
    .btn{appearance:none;border:1px solid var(--border);border-radius:12px;background:var(--btn);color:var(--ink);padding:14px 16px;font-weight:600;cursor:pointer;transition:transform .02s,border-color .2s,box-shadow .2s}
    .btn:hover{border-color:var(--focus);box-shadow:0 0 0 4px rgba(42,195,222,.12) inset}
    .btn:active{transform:translateY(1px)} .btn.ghost{background:transparent}
    .btn.primary{background:#1b2437;border-color:#2b3854}
    .btn.ok{border-color:#2d3b2d;background:#182218}
    .btn.danger{border-color:#3b2d2f;background:#221416}
    .stack{display:grid;gap:6px}
    label{font-size:14px;color:var(--muted)} input[type="range"]{width:100%}
    .meter{font-variant-numeric:tabular-nums}
    .progress{height:8px;border-radius:99px;background:#13151b;border:1px solid var(--border);overflow:hidden;margin-bottom:12px}
    .progress>div{height:100%;background:linear-gradient(90deg,#7aa2f7,#2ac3de);width:0%}
    .pill{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);background:#12151d;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .center{text-align:center}.small{font-size:13px;color:var(--muted)} .hidden{display:none!important}
    .footer{margin-top:18px;display:flex;justify-content:space-between;align-items:center}
    .kbd{font-family:ui-monospace,Menlo,Monaco,Consolas,monospace;background:#0f1320;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    input.input{padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1320;color:var(--ink)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Modernism Origin Judgement Study</h1>
      <div class="muted">Decide whether each artwork is <strong>AI-generated</strong> or <strong>Human-made</strong>. Your answers help our research.</div>
    </header>

    <!-- Consent / Setup -->
    <section id="screen-consent" class="card">
      <div class="row">
        <div>
          <h3>Instructions</h3>
          <p class="muted">
            You will see around <span id="nTrialsLabel">N</span> artworks.
            In some sessions you may also see a modelâ€™s probability hint.
          </p>
          <ul class="muted">
            <li>Use the confidence slider after each choice.</li>
            <li>You canâ€™t go back to previous items.</li>
            <li>Takes under 10 minutes.</li>
          </ul>
        </div>
        <div class="card" style="background:#121621;border-color:#1d2230">
          <div class="stack">
            <label>Condition</label>
            <div>
              <label class="pill"><input type="radio" name="cond" value="solo" checked> solo (no hint)</label>
              <label class="pill" style="margin-left:8px"><input type="radio" name="cond" value="ai"> ai (with hint)</label>
            </div>
            <label>Number of trials</label>
            <input id="nTrials" type="number" min="4" max="1000" step="1" value="20" class="input" />
            <button id="startBtn" class="btn primary">I Consent & Start</button>
            <div class="small">Tip: You can also set <span class="kbd">?cond=solo|ai&n=20</span> in the URL.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Trial Screen -->
    <section id="screen-trial" class="card hidden">
      <div class="progress"><div id="progBar"></div></div>
      <div class="row cols-2">
        <div>
          <div class="imgbox"><img id="artImg" class="art" alt="artwork" /></div>
          <div id="aiHint" class="hint hidden">
            <div><strong>AI hint</strong></div>
            <div class="muted">
              AI generated Likeliness = <span id="pAI" class="meter">â€”</span> â€¢ 
              Human made Likeliness = <span id="pHuman" class="meter">â€”</span><br/>
              <span id="likelyLabel" style="color:var(--accent);font-weight:600"></span>
            </div>
          </div>
        </div>
        <div>
          <div class="pill"><span id="trialBadge">Trial 1</span></div>
          <div class="stack" style="margin-top:8px">
            <label>Make your judgement</label>
            <div class="controls">
              <button class="btn ok" data-answer="human">Human-made</button>
              <button class="btn danger" data-answer="ai">AI-generated</button>
            </div>
          </div>
          <div class="stack" style="margin-top:12px">
            <label>Confidence: <span id="confVal">3</span>/5</label>
            <p class="small">1 = not confident, 5 = extremely confident</p>
            <input id="conf" type="range" min="1" max="5" step="1" value="3" />
          </div>
          <div class="footer">
            <div class="small">No back button. Your response saves automatically.</div>
            <button id="nextBtn" class="btn ghost" disabled>Next</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Finish Screen -->
    <section id="screen-done" class="card hidden center">
      <h3>All done â€” thanks!</h3>
      <p class="muted">Your completion code:</p>
      <p style="font-size:28px;font-weight:800;letter-spacing:1px" id="codeBox">â€”</p>
      <p class="small">Copy this code to submit your study.</p>
      <button id="copyBtn" class="btn primary">Copy Code</button>
    </section>
  </div>

  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>

  <script>
  (function(){
    function showErr(msg){
      const d=document.createElement('div');
      d.style.position='fixed';d.style.left=0;d.style.right=0;d.style.bottom=0;d.style.zIndex=99999;
      d.style.background='#3b0a0a';d.style.color='#fff';d.style.padding='10px 14px';
      d.style.font='12px/1.4 ui-monospace,Menlo,Monaco,Consolas,monospace';
      d.textContent='[ERROR] '+msg;document.body.appendChild(d);console.error(msg);
    }
    window.addEventListener('error',e=>showErr(e.message||String(e.error||e)));
    window.addEventListener('unhandledrejection',e=>showErr(e.reason?(e.reason.message||String(e.reason)):'Unhandled promise rejection'));
  })();

  document.addEventListener('DOMContentLoaded', () => {
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyGqQiNOenbVWk3IuRQG1GADM32xo8iNqQm6vFBtG-oiVSRR8_uXMFqWbE4msv3LaTo/exec';
    const CSV_URL = 'data/stimuli.csv';

    const $  = sel => document.querySelector(sel);
    const $all = sel => Array.from(document.querySelectorAll(sel));
    const params = new URLSearchParams(location.search);

    const uuid = () => ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));
    const clamp01 = x => Math.max(0, Math.min(1, x));
    function shuffle(arr, seed=Math.random()){
      function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}}
      const prng = mulberry32(Math.floor(seed*1e9));
      for(let i=arr.length-1;i>0;i--){const j=Math.floor(prng()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}
      return arr;
    }
    function genParticipantID(){
      const letters="ABCDEFGHJKLMNPQRSTUVWXYZ";
      const nums=Math.floor(1000+Math.random()*9000);
      const prefix=letters[Math.floor(Math.random()*letters.length)];
      return `P${prefix}${nums}`;
    }

    const state = {
      pid: genParticipantID(),
      cond: (params.get('cond') || 'solo').toLowerCase(),
      n: Math.max(1, parseInt(params.get('n') || '20', 10)),
      orderSeed: Math.random().toString().slice(2,10),
      sessionId: uuid(),
      trials: [],
      i: 0, tStart: 0, currentRow: null, completionCode: null
    };

    // UI prefill
    $all('input[name="cond"]').forEach(r => r.checked = (r.value === state.cond));
    const nTrialsEl = $('#nTrials'); if (nTrialsEl) nTrialsEl.value = state.n;
    const nTrialsLabelEl = $('#nTrialsLabel'); if (nTrialsLabelEl) nTrialsLabelEl.textContent = state.n;
    const confEl = $('#conf'); if (confEl) confEl.addEventListener('input', e => { const cv = $('#confVal'); if (cv) cv.textContent = e.target.value; });

    const startBtn = $('#startBtn');
    startBtn.addEventListener('click', async () => {
      const condEl = $all('input[name="cond"]').find(r => r.checked);
      state.cond = condEl ? condEl.value : state.cond;
      state.n = Math.max(1, parseInt((nTrialsEl && nTrialsEl.value) ? nTrialsEl.value : state.n, 10));
      try{
        const rows = await loadCSV(CSV_URL);
        shuffle(rows, parseInt(state.orderSeed,10)/1e8);
        state.trials = rows.slice(0, state.n);
        const sc = $('#screen-consent'); if (sc) sc.classList.add('hidden');
        const st = $('#screen-trial');   if (st) st.classList.remove('hidden');
        state.i = 0;
        renderTrial();
      }catch(err){
        alert('Failed to load CSV: ' + err.message);
      }
    });

    async function loadCSV(url){
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      return parsed.data.map(r => ({
        id:(r.id||'').trim(),
        image_url:(r.image_url||r.url||'').trim(),
        ground_truth:(r.ground_truth||'').trim().toLowerCase(),
        model_prob_ai:(r.model_prob_ai===''||r.model_prob_ai==null)?null:Number(r.model_prob_ai)
      })).filter(r=>r.image_url&&r.id);
    }

    // -------- renderTrial with "likely" label + guards --------
    function renderTrial(){
      const t = state.trials[state.i];
      state.currentRow = t;

      const prog = $('#progBar'); if (prog) prog.style.width = `${(state.i/state.trials.length)*100}%`;
      const badge = $('#trialBadge'); if (badge) badge.textContent = `Trial ${state.i+1} of ${state.trials.length}`;

      const img = $('#artImg');
      if (img) {
        img.src = t.image_url;
        img.onerror = () => alert('Image failed to load: ' + t.image_url);
      }

      const hint = $('#aiHint');
      if (hint) {
        if (state.cond === 'ai' && typeof t.model_prob_ai === 'number' && !Number.isNaN(t.model_prob_ai)) {
          const pAI = clamp01(t.model_prob_ai);
          const pHuman = 1 - pAI;

          const pAIel = $('#pAI');     if (pAIel) pAIel.textContent = pAI.toFixed(2);
          const pHel  = $('#pHuman');  if (pHel)  pHel.textContent  = pHuman.toFixed(2);

          const likely = $('#likelyLabel');
          if (likely) {
            likely.textContent = pAI >= pHuman ? "âš™ï¸ Model suggests: AI-generated" : "ðŸŽ¨ Model suggests: Human-made";
          }

          hint.classList.remove('hidden');
        } else {
          hint.classList.add('hidden');
        }
      }

      const conf = $('#conf'); if (conf) conf.value = 3;
      const confVal = $('#confVal'); if (confVal) confVal.textContent = '3';
      const nextBtn = $('#nextBtn'); if (nextBtn) nextBtn.disabled = true;
      state.tStart = performance.now();
    }
    // ----------------------------------------------------------

    // safe click handler
    $all('.controls .btn').forEach(btn=>{
      btn.addEventListener('click',async e=>{
        const targetBtn = (e.currentTarget && e.currentTarget.closest('.btn')) || e.target.closest('.btn');
        if(!targetBtn) return;
        const answer=(targetBtn.getAttribute('data-answer')||'ai').toLowerCase();
        const rt=Math.round(performance.now()-state.tStart);
        const conf=Number($('#conf')?.value||3);
        const cur=state.currentRow||{};const gt=(cur.ground_truth||'').toLowerCase();
        const correct=gt?(answer===gt):'';
        const payload={
          participant_id:state.pid,condition:state.cond,trial_index:state.i+1,total_trials:state.trials.length,
          stimulus_id:cur.id||'',image_url:cur.image_url||'',model_prob_ai:typeof cur.model_prob_ai==='number'?cur.model_prob_ai:'',
          hint_shown:state.cond==='ai'&&typeof cur.model_prob_ai==='number',response:answer,ground_truth:gt,correct,confidence:conf,
          rt_ms:rt,order_seed:state.orderSeed,session_id:state.sessionId
        };
        try{
          await postRow(payload);
          const nb = $('#nextBtn'); if (nb) nb.disabled=false;
          targetBtn.classList.add('clicked');
          setTimeout(()=>targetBtn.classList.remove('clicked'),200);
        }catch(err){alert('Save failed.\n'+err.message);}
      });
    });

    const nextBtn = $('#nextBtn');
    if (nextBtn) nextBtn.addEventListener('click',async()=>{
      state.i++;
      if(state.i<state.trials.length){ renderTrial(); }
      else{
        state.completionCode='C'+Math.random().toString(36).slice(2,8).toUpperCase();
        try{
          await postRow({
            participant_id:state.pid,condition:state.cond,trial_index:'FINAL',total_trials:state.trials.length,
            stimulus_id:'',image_url:'',model_prob_ai:'',hint_shown:'',
            response:'DONE',ground_truth:'',correct:'',confidence:'',
            rt_ms:'',order_seed:state.orderSeed,session_id:state.sessionId,
            completion_code:state.completionCode
          });
        }catch(e){}
        const st = $('#screen-trial'); if (st) st.classList.add('hidden');
        const sd = $('#screen-done');  if (sd) sd.classList.remove('hidden');
        const cb = $('#codeBox');      if (cb) cb.textContent = state.completionCode;
      }
    });

    const copyBtn = $('#copyBtn');
    if (copyBtn) copyBtn.addEventListener('click',()=>{
      navigator.clipboard.writeText(state.completionCode||'').then(()=>alert('Copied!'));
    });

    async function postRow(row){
      // no-cors simple request; response is opaque (expected)
      await fetch(APPS_SCRIPT_URL,{
        method:'POST',mode:'no-cors',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body:JSON.stringify({...row,ua:navigator.userAgent})
      });
      return { ok:true };
    }
  });
  </script>
</body>
</html>
